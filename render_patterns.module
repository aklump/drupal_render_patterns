<?php
/**
 * @file
 * Base file for the render_patterns module.
 *
 * @defgroup render_patterns Render Patterns
 * @{
 */

use Drupal\render_patterns\PatternInterface;
use Drupal\render_patterns\RenderPatternsMessage;
use Drupal\Core\Render\Markup;

/**
 * Factory function to generate a new pattern instance.
 *
 * @param string $pattern_name
 *   The name of the pattern.
 *
 * @return \Drupal\render_patterns\PatternInterface
 *   The pattern instance.
 *
 * @see \Drupal\render_patterns\PatternFactory::get
 */
function render_patterns_get(string $pattern_name, array $data = []): PatternInterface {
  try {
    return \Drupal::service('render_patterns.factory')
      ->get($pattern_name, $data);
  }
  catch (\Exception $exception) {
    $message = t('In render pattern %name: @message', [
      '%name' => $pattern_name,
      '@message' => $exception->getMessage(),
    ])->__toString();
    \Drupal::messenger()->addError(Markup::create($message));
    $pattern = new RenderPatternsMessage(data_api());
    $pattern->message = $message;

    return $pattern;
  }
}

/**
 * Implements hook_render_patterns_info().
 *
 * Automatically register the default theme as providing render patterns based
 * on the existence of the directory.
 */
function render_patterns_render_patterns_info() {
  $config = \Drupal::service('config.factory')->get('system.theme');
  if (($theme_folder = \Drupal::root() . '/' . drupal_get_path('theme', $config->get('default')) . '/render_patterns')
    && is_dir($theme_folder)) {
    return [
      'directory' => $theme_folder,
      // Give the theme the higher weight so it can override.
      'weight' => 10,
    ];
  }
  return [];
}
